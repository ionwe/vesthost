<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ü—Ä–æ—Å–º–æ—Ç—Ä –≤–∏–¥–µ–æ</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <button class="toggle-sidebar" onclick="toggleSidebar()">‚ò∞</button>
    <div class="sidebar" id="sidebar">
        <a href="index.html"><img src="icons/home.svg" alt="–ì–ª–∞–≤–Ω–∞—è" class="icon"> –ì–ª–∞–≤–Ω–∞—è</a>
        <a href="#"><img src="icons/trending.svg" alt="–ü–æ–ø—É–ª—è—Ä–Ω–æ–µ" class="icon"> –ü–æ–ø—É–ª—è—Ä–Ω–æ–µ</a>
        <a href="#"><img src="icons/flash.svg" alt="–¢—Ä–∞–Ω—Å–ª—è—Ü–∏–∏" class="icon"> –¢—Ä–∞–Ω—Å–ª—è—Ü–∏–∏</a>
        <div class="divider"></div>
        <a href="history.html"><img src="icons/history.svg" alt="–ò—Å—Ç–æ—Ä–∏—è" class="icon"> –ò—Å—Ç–æ—Ä–∏—è</a>
        <a href="#"><img src="icons/playlists.svg" alt="–ü–ª–µ–π–ª–∏—Å—Ç—ã" class="icon"> –ü–ª–µ–π–ª–∏—Å—Ç—ã</a>
        <a href="#"><img src="icons/liked.svg" alt="–ü–æ–Ω—Ä–∞–≤–∏–≤—à–∏–µ—Å—è" class="icon"> –ü–æ–Ω—Ä–∞–≤–∏–≤—à–∏–µ—Å—è</a>
        <div class="divider"></div>
        <div class="subscription-title">–ü–æ–¥–ø–∏—Å–∫–∏</div>
        <a href="#"><img src="icons/channel1.svg" alt="–ö–∞–Ω–∞–ª 1" class="icon"> –ö–∞–Ω–∞–ª 1</a>
        <a href="#"><img src="icons/channel2.svg" alt="–ö–∞–Ω–∞–ª 2" class="icon"> –ö–∞–Ω–∞–ª 2</a>
        <a href="#"><img src="icons/channel3.svg" alt="–ö–∞–Ω–∞–ª 3" class="icon"> –ö–∞–Ω–∞–ª 3</a>
        <a href="#"><img src="icons/channel4.svg" alt="–ö–∞–Ω–∞–ª 4" class="icon"> –ö–∞–Ω–∞–ª 4</a>
        <a href="#"><img src="icons/channel5.svg" alt="–ö–∞–Ω–∞–ª 5" class="icon"> –ö–∞–Ω–∞–ª 5</a>
        <a href="#"><img src="icons/channel6.svg" alt="–ö–∞–Ω–∞–ª 6" class="icon"> –ö–∞–Ω–∞–ª 6</a>
        <div class="divider"></div>
        <a href="#"><img src="icons/settings.svg" alt="–ù–∞—Å—Ç—Ä–æ–π–∫–∏" class="icon"> –ù–∞—Å—Ç—Ä–æ–π–∫–∏</a>
        <a href="#"><img src="icons/help.svg" alt="–°–ø—Ä–∞–≤–∫–∞" class="icon"> –°–ø—Ä–∞–≤–∫–∞</a>
        <a href="#"><img src="icons/feedback.svg" alt="–û—Å—Ç–∞–≤–∏—Ç—å –æ—Ç–∑—ã–≤" class="icon"> –û—Å—Ç–∞–≤–∏—Ç—å –æ—Ç–∑—ã–≤</a>
    </div>

    <div class="main-content">
        <div class="profile-menu" id="profileMenu" style="position: absolute; top: 20px; right: 20px; display: none; align-items: center; gap: 10px;">
            <span id="profileName"></span>
            <img src="icons/profile.svg" alt="–ü—Ä–æ—Ñ–∏–ª—å" class="profile-icon" onclick="window.location.href='profile.html'">
            <button onclick="logout()" class="logout-btn">–í—ã–π—Ç–∏</button>
        </div>
        <div class="auth-buttons" id="authButtons">
            <button onclick="window.location.href='login.html'">–í–æ–π—Ç–∏</button>
            <button onclick="window.location.href='register.html'">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</button>
        </div>

        <div class="video-container">
            <video id="videoPlayer" controls>
                <source src="" type="video/mp4">
                –í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –≤–∏–¥–µ–æ.
            </video>
            <h1 id="videoTitle" class="video-title-main"></h1>
            <div class="video-info">
                <div class="video-actions">
                    <div class="like-dislike-group">
                        <button onclick="likeVideo()" id="likeButton">üëç <span id="likeCount">0</span></button>
                        <button onclick="dislikeVideo()" id="dislikeButton">üëé <span id="dislikeCount">0</span></button>
                    </div>
                    <div class="share-btn-container">
                        <button onclick="shareVideo()">–ü–æ–¥–µ–ª–∏—Ç—å—Å—è</button>
                    </div>
                </div>
            </div>
            <div class="comments-section">
                <h2>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏</h2>
                <div class="comment-form">
                    <textarea id="commentInput" placeholder="–î–æ–±–∞–≤–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π..." oninput="autoResizeTextarea(this)"></textarea>
                    <button onclick="submitComment()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
                </div>
                <div id="commentsList"></div>
            </div>
        </div>
    </div>

    <script src="js/notifications.js"></script>
    <script src="js/auth.js"></script>
    <script>
        let currentVideoId = new URLSearchParams(window.location.search).get('id');
        
        async function loadVideo() {
            try {
                const response = await fetch(`/api/video/${currentVideoId}`);
                const video = await response.json();
                document.getElementById('videoPlayer').src = video.file_path;
                document.getElementById('videoTitle').textContent = video.title;
                updateLikeDislikeCounts();
                fetchComments();
            } catch (error) {
                notifications.show('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –≤–∏–¥–µ–æ', 'error');
            }
        }

        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            sidebar.classList.toggle('hidden');
        }

        async function likeVideo() {
            const userId = localStorage.getItem('userId');
            if (!userId) {
                notifications.show('–í–æ–π–¥–∏—Ç–µ –≤ –∞–∫–∫–∞—É–Ω—Ç, —á—Ç–æ–±—ã –ø–æ—Å—Ç–∞–≤–∏—Ç—å –ª–∞–π–∫', 'error');
                return;
            }
            try {
                await fetch('/api/like', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ video_id: currentVideoId, user_id: userId })
                });
                notifications.show('–õ–∞–π–∫ —É—Å–ø–µ—à–Ω–æ –ø–æ—Å—Ç–∞–≤–ª–µ–Ω', 'success');
                updateLikeDislikeCounts();
            } catch (error) {
                notifications.show('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É—Å—Ç–∞–Ω–æ–≤–∫–µ –ª–∞–π–∫–∞', 'error');
            }
        }

        async function dislikeVideo() {
            const userId = localStorage.getItem('userId');
            if (!userId) {
                notifications.show('–í–æ–π–¥–∏—Ç–µ –≤ –∞–∫–∫–∞—É–Ω—Ç, —á—Ç–æ–±—ã –ø–æ—Å—Ç–∞–≤–∏—Ç—å –¥–∏–∑–ª–∞–π–∫', 'error');
                return;
            }
            try {
                await fetch('/api/dislike', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ video_id: currentVideoId, user_id: userId })
                });
                notifications.show('–î–∏–∑–ª–∞–π–∫ —É—Å–ø–µ—à–Ω–æ –ø–æ—Å—Ç–∞–≤–ª–µ–Ω', 'success');
                updateLikeDislikeCounts();
            } catch (error) {
                notifications.show('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É—Å—Ç–∞–Ω–æ–≤–∫–µ –¥–∏–∑–ª–∞–π–∫–∞', 'error');
            }
        }

        async function updateLikeDislikeCounts() {
            try {
                const likesResponse = await fetch(`/api/likes/${currentVideoId}`);
                const dislikesResponse = await fetch(`/api/dislikes/${currentVideoId}`);
                const likes = await likesResponse.json();
                const dislikes = await dislikesResponse.json();
                document.getElementById('likeCount').textContent = likes.count;
                document.getElementById('dislikeCount').textContent = dislikes.count;
            } catch (error) {
                notifications.show('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å—á–µ—Ç—á–∏–∫–æ–≤', 'error');
            }
        }

        async function submitComment() {
            const userId = localStorage.getItem('userId');
            const commentInput = document.getElementById('commentInput');
            const commentText = commentInput.value.trim();
            if (commentText !== '' && userId) {
                try {
                    await fetch('/api/comment', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ video_id: currentVideoId, user_id: userId, comment: commentText })
                    });
                    commentInput.value = '';
                    autoResizeTextarea(commentInput);
                    notifications.show('–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω', 'success');
                    fetchComments();
                } catch (error) {
                    notifications.show('–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è', 'error');
                }
            } else {
                notifications.show('–í–æ–π–¥–∏—Ç–µ –≤ –∞–∫–∫–∞—É–Ω—Ç, —á—Ç–æ–±—ã –æ—Å—Ç–∞–≤–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π', 'error');
            }
        }

        async function fetchComments() {
            try {
                const response = await fetch(`/api/comments/${currentVideoId}`);
                const comments = await response.json();
                const commentsList = document.getElementById('commentsList');
                commentsList.innerHTML = '';
                comments.forEach(comment => {
                    const div = document.createElement('div');
                    div.className = 'comment';
                    div.innerHTML = `
                        <div class="comment-header">
                            <span class="comment-author">${comment.username}</span>
                            <span class="comment-date">${new Date(comment.created_at).toLocaleDateString()}</span>
                        </div>
                        <div class="comment-text">${comment.comment}</div>
                    `;
                    commentsList.appendChild(div);
                });
            } catch (error) {
                notifications.show('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤', 'error');
            }
        }

        function autoResizeTextarea(textarea) {
            textarea.style.height = 'auto';
            textarea.style.height = textarea.scrollHeight + 'px';
        }

        function shareVideo() {
            const url = window.location.href;
            navigator.clipboard.writeText(url).then(() => {
                notifications.show('–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞ –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞', 'success');
            }).catch(() => {
                notifications.show('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–∏ —Å—Å—ã–ª–∫–∏', 'error');
            });
        }

        loadVideo();
    </script>
</body>
</html>
